<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fee Schedule Lookup – All Plans</title>
  <style>
    :root { 
      --bg:#ffffff; --panel:#fafafa; --muted:#555555; --fg:#000000; --accent:#003366; --border:#cccccc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans";background:var(--bg);color:var(--fg)}

    .wrap{max-width:1200px;margin:0 auto;padding:24px;min-width:1100px}
    h1{margin:0 0 18px;font-size:26px}

    .toolbar{display:grid;grid-template-columns:340px 1fr auto;gap:12px;align-items:center;margin-bottom:12px}
    .toolbar .select, .toolbar .search { width:100%;padding:10px 12px;border-radius:10px;background:#fff;border:1px solid var(--border);color:var(--fg);outline:none }
    .meta{font-size:12px;color:var(--muted);text-align:right}

    .notice{ margin:12px 0; padding:10px 12px; border:1px solid var(--border); background:#fff; color:var(--fg); border-radius:10px; font-size:14px; }
    .notice b{ font-weight:600 }

    table{width:100%;border-collapse:collapse;border:1px solid var(--border);background:var(--panel)}
    thead th{position:sticky;top:0;background:#f2f2f2;color:#000;z-index:1}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left;font-variant-numeric:tabular-nums}
    tbody tr:hover{background:#eef6ff}
    .clickable{cursor:pointer;user-select:none}
    .sort-ind{color:var(--accent);font-size:11px;margin-left:6px}

    .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:10px;color:var(--muted)}
    .pager{display:flex;gap:6px}
    .btn{background:#fff;color:#000;border:1px solid var(--border);border-radius:8px;padding:6px 10px;cursor:pointer}
    .btn[disabled]{opacity:.45;cursor:not-allowed}
    .perpage{background:#fff;color:#000;border:1px solid var(--border);border-radius:8px;padding:6px 10px}

    .debug{margin-top:8px;padding:6px;border:1px dashed #bbb;color:#444;font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; white-space:pre-wrap}
    .special-cell{background:#fff3cd;color:#664d03;font-weight:600}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Fee Schedule Lookup – All Plans</h1>
    <div class="toolbar">
      <select id="plan" class="select" title="Choose an insurance/plan"></select>
      <input id="q" class="search" placeholder="Search HCPCS or text… (e.g., A7030 or mask)" autocomplete="off" />
      <div class="meta"><span id="count">0</span> rows • <span id="status">Select a plan</span></div>
    </div>

    <div id="plan-note" class="notice" hidden></div>

    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="footer">
      <div>
        Rows per page:
        <select id="perpage" class="perpage">
          <option selected>5</option>
          <option>10</option>
          <option>20</option>
        </select>
      </div>
      <div class="pager">
        <button id="prev" class="btn">Prev</button>
        <span id="pageinfo"></span>
        <button id="next" class="btn">Next</button>
      </div>
    </div>

    <div id="debug" class="debug"></div>
  </div>

  <script>
// ===== CONFIG: url, columns, headers, note, computed =====
const INSURERS = {
  'CBA (Former CBA APR 2025)': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/refs/heads/main/formerCBA_APR2025.csv',
    note: 'For RR (rental) rows: Default formula = DFW × 10.5. Special HCPCS (K0800–K0899, E1230–E1239) = Fee ÷ 0.15.',
    computed: [ { header: 'Full Payment (RR)', fn: 'full_rr_cba' } ],
  },

  'Rural & Non CBA (custom view)': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/main/DMEPOS25_APR25.csv',
    columns: [0,1,2,4,89,90,113],
    headers: ['HCPCS','Mod','Mod2','CATG','TX (NR)','TX (R)','Description'],
    note: 'For RR (rental) rows: Default formulas = TX (NR) × 10.5 and TX (R) × 10.5. Special HCPCS (K0800–K0899, E1230–E1239) = Fee ÷ 0.15.',
    computed: [
      { header: 'Full Payment TX (NR)', fn: 'full_rr_txnr' },
      { header: 'Full Payment TX (R)',  fn: 'full_rr_txr'  },
    ],
  },

  'BCBS of Texas': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/refs/heads/main/BCBS_2024_DMEPOS_FEE.csv'
  },

  'Amerigroup': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/refs/heads/main/Amerigroup.csv',
    columns: [0,1,5,7,1,2,3],
    headers: ['HCPCS','Mod','Purchase','Rental','Age From','To',' '],
  },

  'UHC': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/main/DMEPOS25_APR25.csv',
    columns: [0,1,89,113],
    headers: ['HCPCS','Mod','TX (NR)','Description'],
    note: 'We are out of network with United Healthcare, however most plans will pay out of network at Medicare base rates. There is a chance the allowable might be different from what is shown below, but in most cases it will be accurate.',
  },

  'CIGNA': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/main/DMEPOS25_APR25.csv',
    columns: [0,1,89,113],
    headers: ['HCPCS','Mod','TX (NR)','Description'],
    computed: [
      { header: 'Cigna 60%', from: 89, fn: 'pct', pct: 0.60 },
      { header: 'Cigna 70%', from: 89, fn: 'pct', pct: 0.70 },
    ],
    note: 'CIGNA pays 60% of the Medicare unajusted rate, except for Power Mobility which is 70%. Choose the appropriate one per item.',
  },

  'AETNA': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/main/DMEPOS25_APR25.csv',
    columns: [0,1,89,113],
    headers: ['HCPCS','Mod','Allowable','Description'],
    note: 'We are out of network with AETNA, however most plans will pay out of network at Medicare base rates. There is a chance the allowable might be different from what is shown below, but in most cases it will be accurate',
  },

  'Medicaid (TMHP)': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/main/TMHP.csv',
    columns: [1,2,3,4,5,7,6,9,8],
    headers: ['HCPCS','Mod','Age from','To',' ','Purchase','Effective','Rental','Effective'],
  },

  'Amerivantage 2025': {
    url: 'https://raw.githubusercontent.com/AER2436/hcpcs/refs/heads/main/amerivantage_2025.csv'
  },
};

// ===== URL param default plan =====
const params = new URLSearchParams(location.search);
const defaultPlan = params.get('plan');

// ===== Utilities =====
const $ = (s, r=document) => r.querySelector(s);
const el = (t, a={}, kids=[]) => { const n=document.createElement(t); for(const [k,v] of Object.entries(a)){ if(k==='class')n.className=v; else if(k==='text')n.textContent=v; else n.setAttribute(k,v);} for(const c of [].concat(kids)) n.append(c); return n; };

function parseCSV(text){
  const rows=[]; let row=[], field='', i=0, inQ=false; const push=()=>{row.push(field); field='';};
  while(i<text.length){ const c=text[i]; if(inQ){ if(c==='"'){ if(text[i+1]==='"'){field+='"'; i++;} else inQ=false; } else field+=c; }
    else { if(c==='"') inQ=true; else if(c===','){ push(); } else if(c==='\n'){ push(); rows.push(row); row=[]; } else if(c==='\r'){} else field+=c; }
    i++; }
  if(field!==''||row.length){ push(); rows.push(row); }
  if(rows.length && rows[rows.length-1].every(x=>x==='')) rows.pop();
  return rows;
}

function parseMoney(v){ const n = parseFloat(String(v ?? '').replace(/[^0-9.\-]/g,'')); return Number.isFinite(n) ? n : NaN; }
function fmtMoney(n){ if (Number.isNaN(n)) return ''; return n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); }

// ===== Special-case rental formula support =====
const SPECIAL_CODES = new Set([
  'K0813','K0814','K0815','K0816',
  'K0820','K0821','K0822','K0823','K0824','K0825','K0826','K0827','K0828','K0829',
  'K0835','K0836','K0837','K0838','K0839','K0840','K0841','K0842','K0843',
  'K0848','K0849','K0850','K0851','K0852','K0853','K0854','K0855',
  'K0856','K0857','K0858','K0859','K0860','K0861','K0862','K0863','K0864',
  'K0868','K0869','K0870','K0871','K0877',
  'K0884','K0885','K0886','K0887','K0888','K0889','K0890','K0891',
  'K0898','K0899',
]);

function getExceptionSet(cfg){
  if (cfg && Array.isArray(cfg.exceptionCodes) && cfg.exceptionCodes.length) {
    return new Set(cfg.exceptionCodes.map(c => String(c).toUpperCase().trim()));
  }
  return SPECIAL_CODES;
}

// ===== State =====
let headers=[], data=[], filtered=[], sortKey=0, sortDir=1, page=1;
let currentHeaderIndex = {};
let currentExceptionSet = SPECIAL_CODES;
const planSel = $('#plan');
const q = $('#q');
const thead = $('#thead');
const tbody = $('#tbody');
const perSel = $('#perpage');
const pageInfo = $('#pageinfo');
const prev = $('#prev');
const next = $('#next');
const count = $('#count');
const status = $('#status');
const noteEl = document.getElementById('plan-note');
const debug = document.getElementById('debug');

function populatePlans(){
  planSel.innerHTML = '';
  const keys = Object.keys(INSURERS);
  for (const name of keys){ planSel.append(new Option(name, name)); }
  if (defaultPlan) { const match = keys.find(k => k.toLowerCase() === defaultPlan.toLowerCase()); if (match) planSel.value = match; }
  if (debug) debug.textContent = `populatePlans: ${keys.length} plans`;
}

function num(v){ const s=String(v).replace(/[$,\s]/g,''); const n=parseFloat(s); return Number.isFinite(n)?n:NaN; }

function renderHead(displayHeaders){
  thead.innerHTML='';
  const tr = el('tr');
  displayHeaders.forEach((h, idx) => {
    const th = el('th', { class: 'clickable' });
    const label = el('span', { text: h || `Col ${idx+1}` });
    const ind = el('span', { class: 'sort-ind', text: idx === sortKey ? (sortDir === 1 ? '▲' : '▼') : '' });
    th.append(label, ind);
    th.addEventListener('click', () => { if (sortKey === idx) sortDir *= -1; else { sortKey = idx; sortDir = 1; } renderHead(displayHeaders); update(); });
    tr.append(th);
  });
  thead.append(tr);
}

function findColIndexByName(names){
  for(const n of names){ const k=String(n).toLowerCase().trim(); if(k in currentHeaderIndex) return currentHeaderIndex[k]; }
  return -1;
}

function isSpecialCode(row){
  const codeIdx = findColIndexByName(['hcpcs','code']);
  const code = String(row?.[codeIdx] ?? '').toUpperCase().trim();
  return code && currentExceptionSet.has(code);
}

// === CHANGED: return {text, special} so we can highlight cells ===
function rentalTotalFromBase(baseVal, row){
  const n = parseMoney(baseVal);
  if (Number.isNaN(n)) return { text: '', special: false };
  const special = isSpecialCode(row);
  const factor  = special ? (1/0.15) : 10.5;
  return { text: fmtMoney(n * factor), special };
}

function projectRow(row, cfg){
  let out = (!cfg.columns || !cfg.headers) ? row.slice() : cfg.columns.map(ci => row[ci] ?? '');
  if (cfg.computed && cfg.computed.length){
    for (const c of cfg.computed){
      let value = '';
      // We'll push objects for computed cells to support highlighting consistently
      if (c.fn === 'pct'){
        const baseNum = parseMoney(row[c.from]);
        value = { text: fmtMoney(baseNum * (c.pct ?? 0)), special: false };
      }
      else if (c.fn === 'full_rr_cba'){
        const modIdx = findColIndexByName(['mod','modifier']);
        const dfwIdx = findColIndexByName(['dfw']);
        if (modIdx >= 0 && dfwIdx >= 0 && String(row[modIdx]).trim().toUpperCase() === 'RR'){
          value = rentalTotalFromBase(row[dfwIdx], row);
        } else {
          value = { text: '', special: false };
        }
      }
      else if (c.fn === 'full_rr_txnr'){
        const modIdx = findColIndexByName(['mod','modifier']);
        const txnrIdx = findColIndexByName(['tx (nr)','tx nr','tx_non_rural','non rural']);
        if (modIdx >= 0 && txnrIdx >= 0 && String(row[modIdx]).trim().toUpperCase() === 'RR'){
          value = rentalTotalFromBase(row[txnrIdx], row);
        } else {
          value = { text: '', special: false };
        }
      }
      else if (c.fn === 'full_rr_txr'){
        const modIdx = findColIndexByName(['mod','modifier']);
        const txrIdx  = findColIndexByName(['tx (r)','tx r','tx_rural','rural']);
        if (modIdx >= 0 && txrIdx >= 0 && String(row[modIdx]).trim().toUpperCase() === 'RR'){
          value = rentalTotalFromBase(row[txrIdx], row);
        } else {
          value = { text: '', special: false };
        }
      }
      out.push(value);
    }
  }
  return out;
}

// Helper so search/sort handle both primitives and {text,special}
function cellVal(c){ return (c && typeof c === 'object' && 'text' in c) ? c.text : c; }

function update(){
  const cfg = INSURERS[planSel.value];
  const proj = data.map(r => projectRow(r, cfg));
  const term = q.value.trim().toLowerCase();
  filtered = term ? proj.filter(r => r.some(c => String(cellVal(c) || '').toLowerCase().includes(term))) : proj;

  filtered.sort((a,b)=>{
    const av = cellVal(a[sortKey]) ?? '';
    const bv = cellVal(b[sortKey]) ?? '';
    const an = parseFloat(String(av).replace(/[^0-9.\-]/g,'')),
          bn = parseFloat(String(bv).replace(/[^0-9.\-]/g,''));
    const cmp = (!Number.isNaN(an)&&!Number.isNaN(bn)) ? (an-bn) : String(av).localeCompare(String(bv),undefined,{numeric:true});
    return cmp * sortDir;
  });

  const per=parseInt(perSel.value,10); const total=filtered.length; const pages=Math.max(1,Math.ceil(total/per)); if(page>pages) page=pages; const start=(page-1)*per; const slice=filtered.slice(start,start+per);
  tbody.innerHTML='';
  for(const row of slice){
    const tr=el('tr');
    for(const cell of row){
      if (cell && typeof cell === 'object' && 'text' in cell){
        const td = el('td', cell.special ? { class: 'special-cell' } : {});
        td.textContent = cell.text;
        tr.append(td);
      } else {
        tr.append(el('td',{text:cell}));
      }
    }
    tbody.append(tr);
  }
  count.textContent = total.toLocaleString();
  pageInfo.textContent = `Page ${page} / ${pages}`;
  prev.disabled = page<=1; next.disabled = page>=pages;
}

async function loadPlan(){
  const name = planSel.value; const cfg = INSURERS[name]; if (!cfg) return; status.textContent = 'Loading…'; page = 1; sortKey = 0; sortDir = 1; q.value = '';
  if (cfg.note) { noteEl.hidden = false; noteEl.textContent = cfg.note; } else { noteEl.hidden = true; noteEl.textContent = ''; }
  try {
    const res = await fetch(cfg.url, { cache: 'no-store' }); if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text(); const rows = parseCSV(text); headers = rows[0] || []; data = rows.slice(1);
    currentHeaderIndex = {}; headers.forEach((h,i)=>{ currentHeaderIndex[String(h||'').toLowerCase().trim()] = i; });
    currentExceptionSet = getExceptionSet(cfg);
    const baseHeaders = (cfg.columns && cfg.headers) ? cfg.headers : headers;
    const compHeaders = (cfg.computed || []).map(c => c.header);
    renderHead([...baseHeaders, ...compHeaders]);
    update(); status.textContent = name;
  } catch (e) {
    if (debug) debug.textContent = 'loadPlan error: ' + (e && e.message);
    status.textContent = 'Error loading CSV'; thead.innerHTML = '<tr><th>Error</th></tr>'; tbody.innerHTML = ''; count.textContent = '0'; pageInfo.textContent = '';
  }
}

planSel.addEventListener('change', loadPlan);
q.addEventListener('input', () => { page = 1; update(); });
perSel.addEventListener('change', () => { page = 1; update(); });
prev.addEventListener('click', () => { if (page>1) { page--; update(); } });
next.addEventListener('click', () => { page++; update(); });

populatePlans();
if (!planSel.value) planSel.selectedIndex = 0;
if (planSel.value) loadPlan();
</script>

</body>
</html>
